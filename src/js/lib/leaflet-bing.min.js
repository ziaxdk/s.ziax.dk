L.BingLayer=L.TileLayer.extend({options:{subdomains:[0,1,2,3],type:"Aerial",attribution:"Bing",culture:""},initialize:function(t,i){L.Util.setOptions(this,i);this._key=t;this._url=null;this.meta={};this.loadMetadata()},tile2quad:function(t,i,e){var a="";for(var r=e;r>0;r--){var o=0;var n=1<<r-1;if((t&n)!=0)o+=1;if((i&n)!=0)o+=2;a=a+o}return a},getTileUrl:function(t,i){var i=this._getZoomForUrl();var e=this.options.subdomains,a=this.options.subdomains[Math.abs((t.x+t.y)%e.length)];return this._url.replace("{subdomain}",a).replace("{quadkey}",this.tile2quad(t.x,t.y,i)).replace("{culture}",this.options.culture)},loadMetadata:function(){var t=this;var i="_bing_metadata_"+L.Util.stamp(this);window[i]=function(e){t.meta=e;window[i]=undefined;var a=document.getElementById(i);a.parentNode.removeChild(a);if(e.errorDetails){if(window.console)console.log("Leaflet Bing Plugin Error - Got metadata: "+e.errorDetails);return}t.initMetadata()};var e=document.location.protocol+"//dev.virtualearth.net/REST/v1/Imagery/Metadata/"+this.options.type+"?include=ImageryProviders&jsonp="+i+"&key="+this._key+"&UriScheme="+document.location.protocol.slice(0,-1);var a=document.createElement("script");a.type="text/javascript";a.src=e;a.id=i;document.getElementsByTagName("head")[0].appendChild(a)},initMetadata:function(){var t=this.meta.resourceSets[0].resources[0];this.options.subdomains=t.imageUrlSubdomains;this._url=t.imageUrl;this._providers=[];if(t.imageryProviders){for(var i=0;i<t.imageryProviders.length;i++){var e=t.imageryProviders[i];for(var a=0;a<e.coverageAreas.length;a++){var r=e.coverageAreas[a];var o={zoomMin:r.zoomMin,zoomMax:r.zoomMax,active:false};var n=new L.LatLngBounds(new L.LatLng(r.bbox[0]+.01,r.bbox[1]+.01),new L.LatLng(r.bbox[2]-.01,r.bbox[3]-.01));o.bounds=n;o.attrib=e.attribution;this._providers.push(o)}}}this._update()},_update:function(){if(this._url==null||!this._map)return;this._update_attribution();L.TileLayer.prototype._update.apply(this,[])},_update_attribution:function(){var t=this._map.getBounds();var i=this._map.getZoom();for(var e=0;e<this._providers.length;e++){var a=this._providers[e];if(i<=a.zoomMax&&i>=a.zoomMin&&t.intersects(a.bounds)){if(!a.active&&this._map.attributionControl)this._map.attributionControl.addAttribution(a.attrib);a.active=true}else{if(a.active&&this._map.attributionControl)this._map.attributionControl.removeAttribution(a.attrib);a.active=false}}},onRemove:function(t){for(var i=0;i<this._providers.length;i++){var e=this._providers[i];if(e.active&&this._map.attributionControl){this._map.attributionControl.removeAttribution(e.attrib);e.active=false}}L.TileLayer.prototype.onRemove.apply(this,[t])}});L.bingLayer=function(t,i){return new L.BingLayer(t,i)};